name: MomentoMori Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy-start:
    name: Deploy Start
    runs-on: ubuntu-latest
    environment: production
    outputs:
      start_time: ${{ steps.set_start_time.outputs.start_time }}
    steps:
      - uses: actions/checkout@v4
      - name: Set deployment start time
        id: set_start_time
        run: |
          echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
      - name: Send Deploy Start Notification
        uses: appleboy/telegram-action@master
        with:
          to: "-1002335330675"
          token: ${{ secrets.TELEGRAM_DEPLOY_TOKEN_BOT }}
          message: |
            üöÄ –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –¥–µ–ø–ª–æ–π MomentoMori –Ω–∞ production

            –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
            Commit: ${{ github.event.head_commit.message }}
            Branch: ${{ github.ref_name }}
            Author: ${{ github.event.head_commit.author.name }}

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    environment: production
    needs: [deploy-start]
    steps:
      - uses: actions/checkout@v4

      - name: Set docker image name
        run: |
          echo "APP_IMAGE=momentomori-app" >> $GITHUB_ENV

      - name: Build Docker image
        run: docker compose -p momentomori -f docker-compose.yml build

      - name: List Docker images (debug)
        run: docker images | grep momentomori

      - name: Save Docker image artifact
        run: |
          docker save momentomori-app:latest -o app_image.tar

      - name: Deploy to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.BEGET_HOST }}
          username: "root"
          key: ${{ secrets.BEGET_SSH_PRIVATE_KEY }}
          passphrase: "428"
          source: "app_image.tar,templates,momento.svg,Dockerfile,docker-compose.yml,.dockerignore"
          target: "/docker-compose/momentomori"
          overwrite: true

      - name: Start Application
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BEGET_HOST }}
          username: "root"
          key: ${{ secrets.BEGET_SSH_PRIVATE_KEY }}
          passphrase: "428"
          script: |
            cd /docker-compose/momentomori

            COMPOSE_CMD="docker-compose -p momentomori -f docker-compose.yml"

            $COMPOSE_CMD down || true

            if [ -f app_image.tar ]; then
              echo "üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
              docker load -i app_image.tar
              rm app_image.tar
            else
              echo "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Ñ–∞–π–ª app_image.tar –Ω–µ –Ω–∞–π–¥–µ–Ω."
            fi

            echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            $COMPOSE_CMD up -d

            sleep 10
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
            $COMPOSE_CMD ps

            echo ""
            echo "üìù –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
            docker logs momentomori-app --tail=30

      - name: Calculate deployment time
        id: deploy-time
        if: success() || failure()
        run: echo "time=$(expr $(date +%s) - ${{ needs.deploy-start.outputs.start_time }}) —Å–µ–∫—É–Ω–¥" >> $GITHUB_OUTPUT

      - name: Send Success Notification
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: "-1002335330675"
          token: ${{ secrets.TELEGRAM_DEPLOY_TOKEN_BOT }}
          message: |
            ‚úÖ –î–µ–ø–ª–æ–π MomentoMori —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!

            üì¶ –†–∞–∑–≤–µ—Ä–Ω—É—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
            ‚Ä¢ momentomori-app (Go –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ä—Ç—É 2129)

            –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: https://github.com/${{ github.repository }}
            Commit: ${{ github.event.head_commit.message }}
            Branch: ${{ github.ref_name }}
            Author: ${{ github.event.head_commit.author.name }}
            ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${{ steps.deploy-time.outputs.time }}

      - name: Send Failure Notification
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: "-1002335330675"
          token: ${{ secrets.TELEGRAM_DEPLOY_TOKEN_BOT }}
          message: |
            ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ MomentoMori!

            –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: https://github.com/${{ github.repository }}
            Commit: ${{ github.event.head_commit.message }}
            Branch: ${{ github.ref_name }}
            Author: ${{ github.event.head_commit.author.name }}
            –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ –æ—à–∏–±–∫–∏: ${{ steps.deploy-time.outputs.time }}
